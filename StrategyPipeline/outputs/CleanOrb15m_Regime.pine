// This Pine Script was AUTO-GENERATED by the StrategyPipeline
// Strategy: CleanOrb15m (Robust + Regime Filters)

//@version=5
strategy("NQ 15m ORB [Regime]", overlay=true, margin_long=100, margin_short=100, currency=currency.USD, commission_type=strategy.commission.cash_per_contract, commission_value=2.05, slippage=0)

// --- Robust Inputs ---
sl_atr_mult = input.float(2.0, "SL ATR Mult")
tp_atr_mult = input.float(2.0, "TP ATR Mult")
ema_period = input.int(50, "Trend EMA")
adx_threshold = input.float(20.0, "ADX Threshold")
atr_max = input.float(3.0, "Max Range Checks (ATR)")

// --- Regime Filters (New) ---
use_macro_filter = input.bool(true, "Use Macro Trend Filter (Daily SMA 200)")
use_rvol = input.bool(true, "Use RVOL Filter")
rvol_thresh = input.float(1.2, "RVOL Threshold")

// --- Time Settings ---
orb_start_hour = 9
orb_start_minute = 30
orb_end_hour = 9
orb_end_minute = 45

// --- Logic ---
t = time(timeframe.period, "0930-1600")
is_session = not na(t)

// Indicators
ema_val = ta.ema(close, ema_period)
[diplus, diminus, adx_val] = ta.dmi(14, 14)
atr_val = ta.atr(14)

// Macro Trend (Daily SMA 200)
daily_sma = request.security(syminfo.tickerid, "D", ta.sma(close, 200))
macro_trend_ok = not use_macro_filter or (close > daily_sma)

// RVOL (Relative Volume)
vol_ma = ta.sma(volume, 20)
rvol = volume / vol_ma
rvol_ok = not use_rvol or (rvol > rvol_thresh)

// ORB Range
var float orb_high = na
var float orb_low = na
var int trades_today = 0

// Reset Daily
if ta.change(time("D"))
    orb_high := na
    orb_low := na
    trades_today := 0

if (hour == orb_start_hour and minute == orb_start_minute)
    orb_high := high
    orb_low := low
else if (hour == orb_start_hour and minute >= orb_start_minute and minute < orb_end_minute)
    orb_high := math.max(orb_high, high)
    orb_low := math.min(orb_low, low)

plot(orb_high, "Range High", color=color.green, style=plot.style_stepline)
plot(orb_low, "Range Low", color=color.red, style=plot.style_stepline)
plot(ema_val, "EMA", color=color.yellow)
plot(use_macro_filter ? daily_sma : na, "Daily SMA 200", color=color.blue, linewidth=2)

// Entry Conditions
range_size = orb_high - orb_low
is_compressed = range_size < (atr_val * atr_max)
has_adx = adx_val > adx_threshold

// Trade Logic (1 per day + Filters)
long_cond = close > orb_high and close > ema_val and has_adx and is_compressed and is_session and strategy.position_size == 0 and trades_today == 0 and macro_trend_ok and rvol_ok
short_cond = close < orb_low and close < ema_val and has_adx and is_compressed and is_session and strategy.position_size == 0 and trades_today == 0 and macro_trend_ok and rvol_ok

// Execution
if (long_cond)
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", "Long", stop=close - (atr_val * sl_atr_mult), limit=close + (atr_val * tp_atr_mult))
    trades_today := trades_today + 1

if (short_cond)
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", "Short", stop=close + (atr_val * sl_atr_mult), limit=close - (atr_val * tp_atr_mult))
    trades_today := trades_today + 1

// EOD Flatten
if (hour == 15 and minute == 45)
    strategy.close_all(comment="EOD")
