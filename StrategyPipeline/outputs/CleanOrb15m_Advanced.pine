// This Pine Script was AUTO-GENERATED by the StrategyPipeline
// Strategy: CleanOrb15m (Advanced Regimes: VIX + Chop)

//@version=5
strategy("NQ 15m ORB [Advanced]", overlay=true, margin_long=100, margin_short=100, currency=currency.USD, commission_type=strategy.commission.cash_per_contract, commission_value=2.05, slippage=0)

// --- Robust Inputs ---
sl_atr_mult = input.float(2.0, "SL ATR Mult")
tp_atr_mult = input.float(2.0, "TP ATR Mult")
ema_period = input.int(50, "Trend EMA")
adx_threshold = input.float(20.0, "ADX Threshold")
atr_max = input.float(3.0, "Max Range Checks (ATR)")

// --- Advanced Regime Filters ---
grp_regime = "Regime Filters"
use_vix_filter = input.bool(true, "Use VIX Floor (High Vol)", group=grp_regime)
vix_min = input.float(15.0, "Min VIX Level", group=grp_regime)
use_chop_filter = input.bool(true, "Use Choppiness Index (Trend)", group=grp_regime)
chop_len = input.int(14, "Chop Length", group=grp_regime)
chop_thresh = input.float(61.8, "Max Chop (Lower = Stronger Trend)", group=grp_regime)

// --- Time Settings (New York Time) ---
orb_start_hour = 9
orb_start_minute = 30
// Session for Trading (09:45 - 15:45 NY)
trade_session = "0945-1545:1234567"

// --- Logic (Timezone Aware) ---
// Returns true if current bar is within trading session (NY Time)
in_trade_session = not na(time(timeframe.period, trade_session, "America/New_York"))

// Indicators
ema_val = ta.ema(close, ema_period)
[diplus, diminus, adx_val] = ta.dmi(14, 14)
atr_val = ta.atr(14)

// 1. Choppiness Index (0-100)
chop_atr_sum = math.sum(ta.atr(1), chop_len)
chop_high = ta.highest(chop_len)
chop_low = ta.lowest(chop_len)
chop_val = 100 * math.log10(chop_atr_sum / (chop_high - chop_low)) / math.log10(chop_len)
chop_ok = not use_chop_filter or (chop_val < chop_thresh)

// 2. VIX Filter
vix_close = request.security("CBOE:VIX", "D", close)
vix_ok = not use_vix_filter or (vix_close > vix_min)

// ORB Range Capture (Explicit 09:30 ET Candle)
var float orb_high = na
var float orb_low = na
var int trades_today = 0

// Detect New Day (NY Time)
is_new_day = ta.change(time("D", "America/New_York"))
if is_new_day
    orb_high := na
    orb_low := na
    trades_today := 0

// Capture High/Low EXACTLY at 09:30 ET
ny_hour = hour(time, "America/New_York")
ny_minute = minute(time, "America/New_York")

if (ny_hour == orb_start_hour and ny_minute == orb_start_minute)
    orb_high := high
    orb_low := low
// If using < 15m timeframe, we would need max/min logic for 15 mins. 
// Assuming 15m timeframe as per strategy name.
// If user uses 5m, this only captures the first 5m. 
// Robustness fix: Capture max/min during 09:30-09:45 window
if (ny_hour == 9 and ny_minute >= 30 and ny_minute < 45)
    orb_high :=  na(orb_high) ? high : math.max(orb_high, high)
    orb_low := na(orb_low) ? low : math.min(orb_low, low)

plot(orb_high, "Range High", color=color.green, style=plot.style_stepline)
plot(orb_low, "Range Low", color=color.red, style=plot.style_stepline)
plot(ema_val, "EMA", color=color.yellow)

// Entry Conditions
range_size = orb_high - orb_low
is_compressed = range_size < (atr_val * atr_max)
has_adx = adx_val > adx_threshold

// Trade Logic (1 per day + Advanced Filters)
long_cond = close > orb_high and close > ema_val and has_adx and is_compressed and in_trade_session and strategy.position_size == 0 and trades_today == 0 and chop_ok and vix_ok
short_cond = close < orb_low and close < ema_val and has_adx and is_compressed and in_trade_session and strategy.position_size == 0 and trades_today == 0 and chop_ok and vix_ok

// Execution
if (long_cond)
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", "Long", stop=close - (atr_val * sl_atr_mult), limit=close + (atr_val * tp_atr_mult))
    trades_today := trades_today + 1

if (short_cond)
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", "Short", stop=close + (atr_val * sl_atr_mult), limit=close - (atr_val * tp_atr_mult))
    trades_today := trades_today + 1

// EOD Flatten (15:45 NY Time)
if (ny_hour == 15 and ny_minute == 45)
    strategy.close_all(comment="EOD")
